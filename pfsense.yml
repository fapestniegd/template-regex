---
regex_tpl:
  ANYTHING: '.*'
  DATE: '[0-9]{4}-[0-9]{2}-[0-9]{2}'
  TIME: '[0-9]{2}:[0-9]{2}:[0-9]{2}'
  TZ_OFF: '[+\-][0-9]{2}:[0-9]{2}'
  DIRECTION: in|out
#  DURATION: \S+
#  FTP_FILE: \S+
#  FTP_USER: \S+
  HEX: 0x\S+
  HOSTNAME: \S+
  IFACE: \S+
  RULE: \S+
#  IFACE_IP: '[^:]+:[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'
#  IFACE_IP_PORT: '[^:]+:[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+'
#  IFACE_IP_PORT_P: '[^:]+:[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+\s+\([^\)]*\)'
#  IFACE_IP_SVC: '[^:]+:[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/\S+'
  INT: \d+
  ACTION: pass|block
  IP: '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'
#  IPSEC_STAGE: .*
  IP_PORT: '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+'
#  REASON: TCP FINs|TCP Reset-I|TCP Reset-O|SYN Timeout|FIN Timeout|looping-address|Parent flow is closed
#  SESSION: '[0-9]+'
  FLAGS: S|A|SA
#  TRANSPORT: TCP|UDP
#  TUNNEL_GROUP: \S+
#  TYPE_CODE: '\(type \d+, code \d+\)'
#  USER_P: \(\S+\)
  P_DATA: \([^()]*\([^()]*\)[^()]*\)
  QUERY: PTR|A|SRV|TXT|AAAA
################################################################################
# Here we have nested log substrings and their names, the logic being that 
# you can match the first part of a line, and then iterate to match the 
# remainder of the line. What you should get out of the function is the 
# dot-delimited name of the path it took
# ( e.g. cisco_asa.ipsec_message.constr_blank_hash ) a list of patterns matched
# by each of the (expanded) templates
# since cisco_ass.local_host_teardown "expands" to:
# '[% DATE %]T[% TIME %][% TZ_OFF %] [% HOSTNAME %] [% ASA_CODE %] Teardown local-host [% IFACE_IP %] duration [% DURATION %]'
# There would be a list of 7 elements of the 7 patterns matched by [% TAGS %]
# if you need finer resolution into the tag, break it out into smaller tags
# ( e.g. [% IP %] can become [% INT %]\.[% INT %]\.[% INT %]\.[% INT %] )
#
# The reaoning behind this is that you can triggre a function on cisco_asa.local_host_buildup,
# and pass it the list of 6 patterns that matched as arguments 
################################################################################
log_tpl:
 - name: pfsense
   regex: '[% DATE %]T[% TIME %][% TZ_OFF %] [% HOSTNAME %] pf: '
   remainder: 
     - name: number_11
       regex: '#011\s+'
       remainder:
         - name: origninator
           regex: 'Originator - '
           remainder:
             - name: receive_timestamp
               regex: 'Receive Timestamp:\s+'
               remainder:
                 - name: remainder
                   regex: '[% ANYTHING %]'
             - name: transmit_timestamp
               regex: 'Transmit Timestamp:\s+'
               remainder:
                 - name: remainder
                   regex: '[% ANYTHING %]'
             - name: remainder
               regex: '[% ANYTHING %]'
         - name: originator_timestamp
           regex: 'Originator Timestamp:\s+'
           remainder:
             - name: remainder
               regex: '[% ANYTHING %]'
         - name: receive_timestamp
           regex: 'Receive Timestamp:\s+'
           remainder:
             - name: remainder
               regex: '[% ANYTHING %]'
         - name: reference_timestamp
           regex: 'Reference Timestamp:\s+'
           remainder:
             - name: remainder
               regex: '[% ANYTHING %]'
         - name: remainder
           regex: '[% ANYTHING %]'
     - name: icmp
       regex: '[% INT %] rule [% RULE %]: [% ACTION %] [% DIRECTION %] on [% IFACE %]: [% P_DATA %] [% IP %] > [% IP %]: '
       remainder:
         - name: echo_request
           regex: 'ICMP echo request, id [% INT %], seq [% INT %], length [% INT %]'
         - name: remainder
           regex: '[% ANYTHING %]'
     - name: connection
       regex: '[% INT %] rule [% RULE %]: [% ACTION %] [% DIRECTION %] on [% IFACE %]: [% P_DATA %] [% IP_PORT %] > [% IP_PORT %]: '
       remainder:
         - name: ntpv3
           regex: 'NTPv3, length [% INT %]'
         - name: netbios_bcast
           regex: 'NBT UDP PACKET.137.: QUERY; REQUEST; BROADCAST'
         - name: netbios_packet
           regex: 'NBT UDP PACKET.138.'
         - name: tcp
           regex: '[% FLAGS %], cksum [% HEX %] .correct., [% INT %]:[% INT %].[% INT %]. win [% INT %] '
 #<mss [% INT %],nop,nop,sackOK>'
           remainder:
             - name: no_stamp
               regex: '<mss 1460,nop,nop,sackOK>'
             - name: wscale
               regex: '<mss 1460,nop,wscale 8,nop,nop,sackOK>'
             - name: with_stamp
               regex: '<mss 1460,sackOK,timestamp [% INT %] 0,nop,wscale 7>'
             - name: remainder
               regex: '[% ANYTHING %]'
         - name: tcp
           regex: '[% FLAGS %], cksum [% HEX %] .correct., [% INT %]:[% INT %].[% INT %]. win [% INT %] <mss [% INT %],nop,nop,sackOK>'
         - name: dns
           regex: '[% INT %]\+ [% QUERY %]\? [% HOSTNAME %]\. .[% INT %].'
         - name: dns
           regex: '[% INT %]+ [% DNS_LOOKUP %]? \S+ .[% INT %].'
         - name: tcp_stuff
           regex: '[% FLAGS %], cksum [% HEX %] (correct), [% INT %]:[% INT %].[% INT %]. win [% INT %] <mss [% INT %],nop,nop,sackOK>'
         - name: remainder
           regex: '[% ANYTHING %]'
 - name: no_match
   regex: '[% ANYTHING %]'
